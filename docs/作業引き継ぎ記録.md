# EC-LIVEプロジェクト 作業引き継ぎ記録（2025-08-03時点）

## ここまでの作業内容

- EC-LIVEのAPI接続基盤（FastAPI＋BASE APIクライアント構成）を新規実装
    - ディレクトリ構成・ファイル内容は下記
        - app/config.py … 設定管理
        - app/schemas/item.py … 商品スキーマ
        - app/api_client/base_api_client.py … BASE API接続クライアント
        - app/main.py … FastAPIエンドポイント
        - app/tests/ … テスト一式（test_base_api_client.py, test_main.py）
        - requirements.txt … 必要パッケージ
        - README.md … セットアップ・ローカル起動手順説明
- 上記をmainブランチにプッシュ済み

---

## Renderデプロイ準備

- 専用マニュアル（docs/RENDER_DEPLOY_GUIDE.md）を作成・保存済み
    - Renderでの「Web Service」新規作成方法
    - Build/Startコマンド（公式準拠）
    - 環境変数（.envの内容）をWeb管理画面に手動登録する方法
    - 動作確認手順
    - 運用・更新・トラブル対応例
    - READMEへの案内例

---

## 注意点・引き継ぎ事項

- .envファイルはローカルでのみ利用可。Renderでは必ず「Environment Variables」から登録すること
- requirements.txt更新時は必ずGitHubにpush
- mainブランチへのpushで自動デプロイされる
- BASE_API_URLやBASE_ACCESS_TOKENなどの機密情報は漏洩しないように注意
- テストはpytestで実行可能（ローカルでもCIでも）
- 不明点・エラー時は「Deploy logs」や公式ドキュメント参照

---

## 次回以降の作業予定

- Renderへの実デプロイ・動作確認（マニュアルに従う）
- 必要に応じてREADME等のアップデート、追加テスト実装

---

## 補足

- 本記録は引き継ぎ・再開時の情報共有用。  
  明日以降、AIアシスタントに同じ説明を求める必要がないよう、プロジェクトの重要ポイント・注意点・進捗を網羅的に記載。

---

担当: mikky0415  
記録日: 2025-08-03

---

## 2025-08-11 追記（ルール・作業内容・進捗の記録）

### 1) 運用ルール・技術方針（重要）
- デプロイ/ブランチ
  - 本番デプロイは main ブランチのみから行う（Render: autoDeploy=true）。
  - Render の起動は uvicorn 固定（gunicorn は未使用）。
- OAuth/BASE API 接続
  - BASE API ホストは https://api.thebase.in を既定とする。
  - 認可: GET https://api.thebase.in/1/oauth/authorize
  - トークン: POST https://api.thebase.in/1/oauth/token
  - /auth/exchange では client_id/client_secret を常にボディへ含め、必要に応じて Basic 認証も併用可。
  - リダイレクトURIは https://ec-live.onrender.com/callback を既定。
- /items プロキシ
  - Accept: application/json と適切な User-Agent を付与する。
  - 上流エラーは本文/ステータスを保ったまま伝搬し、非JSON本文も安全に処理する。
  - レート制限は Retry-After を尊重し、BASEの hour_api_limit/day_api_limit は 429 に正規化・待機時間を計算して返す。
  - 過剰な上流リクエストを避けるため、成功レスポンスを短期キャッシュ（TTL既定30秒）し、バックオフ中は上流へ出さない。
- ヘルスチェック
  - 外形監視/ロードバランサは /healthz を使用する（/items を使用しない）。
- 機密情報
  - 各種シークレットは .env ではなく Render の Environment Variables で管理する。

### 2) 環境変数一覧（既定値・用途）
- BASE_API_URL: 既定 https://api.thebase.in
- BASE_ACCESS_TOKEN: /items 用トークン（必須）
- BASE_CLIENT_ID, BASE_CLIENT_SECRET: OAuth クライアント資格情報（/auth/exchange で必須）
- BASE_OAUTH_TOKEN_URL: 既定 https://api.thebase.in/1/oauth/token（任意）
- BASE_OAUTH_AUTHORIZE_URL: 既定 https://api.thebase.in/1/oauth/authorize（任意）
- BASE_REDIRECT_URI: 既定 https://ec-live.onrender.com/callback（任意）
- ITEMS_CACHE_TTL_SECONDS: 既定 30。/items 成功レスポンスのTTL（秒）。
- ITEMS_DEFAULT_BACKOFF_SECONDS: 既定 60。Retry-After不在時の保守的バックオフ（秒）。

### 3) 本日時点の作業内容（実装/更新）
- /items エンドポイント実装と強化
  - クエリパススルー（visible, order, sort, limit, offset, category_id, max_image_no, image_size）。
  - Accept ヘッダーと User-Agent 付与、非JSON本文にも耐えるエラーハンドリング。
  - レート制限の 429 伝搬、Retry-After ヘッダー尊重、hour/day 制限の429マッピングと次の時間/日までの backoff 計算。
  - 短期キャッシュ（ITEMS_CACHE_TTL_SECONDS）、グローバルバックオフ（ITEMS_DEFAULT_BACKOFF_SECONDS）。
- OAuth フロー補助エンドポイント
  - /auth/authorize リダイレクト、/auth/exchange（コード→トークン）、/auth/debug（設定可視化）。
- ヘルスチェック
  - /healthz を追加し、Render の healthCheckPath を /healthz に統一。
- デプロイ/設定
  - render.yaml を thebase.in へ統一、環境変数（ITEMS_*）を追加。
  - docs/render.yaml と デプロイガイドを uvicorn 起動/新規環境変数に更新。
- ドキュメント
  - README に /healthz, /auth/* と新環境変数（ITEMS_*) を追記。

### 4) 事象/対策ログ（抜粋）
- 404/認可エラー: 認可URLのホスト誤り（admin.* 方向）→ api.thebase.in に統一し /auth/authorize 追加で解消。
- 500（JSONDecodeError）: 上流が非JSONエラー本文を返すケース → Content-Type 判定で安全に処理、500 を回避。
- 429 多発: 上流のレート制限 → TTLキャッシュ/バックオフ、Retry-After 伝搬、hour/day 制限の 429 正規化で安定化。
- Render 起動失敗: gunicorn not found → uvicorn 起動に切替、render.yaml で固定。

### 5) 動作確認状況
- ローカル/CI テスト: 14 passed（警告1件: urllib3/LibreSSL）。
- 本番 URL: https://ec-live.onrender.com/
- OAuth コールバック: https://ec-live.onrender.com/callback

### 6) 未対応/フォローアップ
- Render のサービス設定で healthCheckPath=/healthz になっているか最終確認。
- 運用状況に応じて ITEMS_CACHE_TTL_SECONDS / ITEMS_DEFAULT_BACKOFF_SECONDS のチューニング。
- （任意）/auth/refresh 実装の検討（長期運用時のトークン更新用）。

— 記録: 2025-08-11 by チーム